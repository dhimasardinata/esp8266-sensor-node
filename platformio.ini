; =================================================================
; PlatformIO Project Configuration File (Final, Multi-Board)
;
; Simplified structure to eliminate warnings and improve clarity.
; Supports Wemos D1 Mini and NodeMCU v2 with Release, Debug, and Analysis builds.
; =================================================================

[platformio]
default_envs = wemosd1mini_usb
build_cache_dir = .pio/cache

; =================================================================
; ===== Common Environment - Template for all builds =====
; =================================================================
[env]
platform = espressif8266@4.2.1
framework = arduino
monitor_speed = 115200
board_build.filesystem = littlefs
monitor_filters = esp8266_exception_decoder, default
upload_protocol = esptool
lib_deps =
    sensirion/arduino-sht@1.2.6
    claws/BH1750@1.3.0
    esp32async/ESPAsyncWebServer@3.8.1

build_unflags = -std=gnu++17

; --- Global Flags ---
; Only flags required by ALL parts (including libraries) are placed here.
; All warning/error flags are moved to 'build_src_flags'.
build_flags =
    -std=gnu++20
    ; -Wno-volatile
    ;-DASYNC_TCP_USE_BEARSSL=1
    ;-DASYNC_TCP_SSL_ENABLED=1
    -fno-rtti
    -fno-exceptions
    -ffunction-sections
    -fdata-sections
    -Wl,--gc-sections
    -D PIO_FRAMEWORK_ARDUINO_MMU_CACHE16_IRAM48_SECHEAP_SHARED
    -D PIO_FRAMEWORK_ARDUINO_LWIP2_LOW_MEMORY
    -D CACHE_CRC_TABLE_IN_RAM=0

; --- Project Source Code Specific Flags ---
; These flags will ONLY apply to files within the 'src/' folder.
; This is key to applying -Werror only to source code.
build_src_flags =
    -fstack-protector-strong
    -fstack-clash-protection
    -fno-omit-frame-pointer
    -D_FORTIFY_SOURCE=2
    -Wall
    -Wextra
    -Wpedantic
    -Werror
    -Wformat
    -Wformat-truncation=2
    -Wformat-overflow=2
    -Warray-bounds=2
    -Wstringop-overflow=4
    -Wreturn-local-addr
    -Wstrict-overflow=5
    -Wconversion
    -Wsign-conversion
    -Warith-conversion
    -Wfloat-equal
    -Wshadow=local
    -Wduplicated-branches
    -Wduplicated-cond
    -Wswitch-enum
    -Wswitch-default
    -Wmissing-declarations
    -Wnull-dereference
    -Weffc++
    -Woverloaded-virtual
    -Wold-style-cast
    -Wsign-promo
    -Wvolatile
    -Wunused
    -Wstack-usage=1024
    -fstack-usage
    -fdiagnostics-color=always
    -fmessage-length=0
    -fdiagnostics-show-option
    -Wno-unknown-pragmas
    -fno-threadsafe-statics
    -Wdouble-promotion

; +++ STATIC ANALYSIS CONFIGURATION +++
check_tool = cppcheck, clangtidy
check_flags =
    cppcheck: --enable=all --std=c++20 --inconclusive --addon=cert.py --suppress=missingIncludeSystem --inline-suppr --suppress=unusedFunction
    clangtidy: --checks=-*,bugprone-*,cert-*,clang-analyzer-*,cppcoreguidelines-*,modernize-*,performance-*,readability-* --readability-identifier-naming --cppcoreguidelines-pro-bounds-pointer-arithmetic --cppcoreguidelines-pro-bounds-array-to-pointer-decay --modernize-use-trailing-return-type --llvmlibc-* --export-fixes=clang_tidy_fixes.yaml

; =================================================================
; ===== Concrete Environments (Specific to each board & build) =====
; =================================================================

; --- WEMOS D1 MINI ---
[env:wemosd1mini_usb]
extends = env
board = d1_mini
build_type = release
extra_scripts = 
    pre:scripts/inject_config.py
    ;pre:scripts/format_all.py
    pre:scripts/extra_script.py
    ;pre:scripts/prepare_assets.py
    pre:scripts/web_to_header.py
    pre:scripts/convert_certs.py
    post:scripts/convert_sysincludes.py
build_flags =
    ${env.build_flags}
    -Os

[env:wemosd1mini_ota]
extends = env:wemosd1mini_usb
upload_protocol = espota

; --- NODEMCU V2 ---
[env:nodemcuv2_usb]
extends = env:wemosd1mini_usb
board = nodemcuv2

[env:nodemcuv2_ota]
extends = env:nodemcuv2_usb
upload_protocol = espota

[env:integration_test_mocked]
extends = env:wemosd1mini_usb
test_filter = test_integration
build_flags = ${env:wemosd1mini_usb.build_flags}
build_src_flags =

[env:native]
platform = native
framework = 
lib_deps = 
build_src_flags =
test_filter = test_native_*
lib_ignore = 
    GreenhouseCommon
    ESPAsyncWebServer
    ESP8266WiFi
    ESP8266mDNS
    LittleFS
    ArduinoOTA
    DNSServer
    arduino-sht
    BH1750
build_flags = 
    -std=gnu++20
    -D NATIVE_TEST
    -I test/mocks
    -I lib/GreenhouseCommon
    -I include
